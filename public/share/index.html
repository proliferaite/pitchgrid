<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Grid - PitchGrid</title>
    <meta name="description" content="View shared PitchGrid analysis">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="Shared Grid - PitchGrid">
    <meta property="og:description" content="View this video analysis in the PitchGrid app">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://pitchgridapp.com/pitchgrid-icon-1024.png">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Shared Grid - PitchGrid">
    <meta name="twitter:description" content="View this video analysis in the PitchGrid app">
    <meta name="twitter:image" content="https://pitchgridapp.com/pitchgrid-icon-1024.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            text-align: center;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        p {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .button {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 16px 32px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        .secondary-button {
            display: inline-block;
            margin-top: 15px;
            color: white;
            opacity: 0.8;
            text-decoration: underline;
            font-size: 14px;
        }
        
        .secondary-button:hover {
            opacity: 1;
        }
        
        .status {
            margin-top: 20px;
            font-size: 14px;
            opacity: 0.7;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        .info-box {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-size: 15px;
            line-height: 1.6;
            display: none;
        }
        
        .info-box.show {
            display: block;
        }
        
        .info-box strong {
            display: block;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">‚öæÔ∏è</div>
        <h1 id="gridName">Shared PitchGrid</h1>
        <p id="gridInfo" style="opacity: 0.7; font-size: 14px; margin-bottom: 10px;"></p>
        <p id="message">Opening this grid in the PitchGrid app...</p>
        <div class="status" id="status">
            <span class="spinner"></span>
        </div>
        <a href="#" class="button" id="openButton" style="display:none;">Open in PitchGrid</a>
        <a href="#" class="button" id="installButton" style="display:none; margin-top: 10px; background: rgba(255,255,255,0.2); border: 2px solid white;">Get PitchGrid from App Store</a>
        <div class="info-box" id="infoBox">
            <strong>‚ö†Ô∏è Important:</strong>
            After installing or updating PitchGrid, return to this page and tap the "Open in PitchGrid" button above to view the shared grid. If you just open the app directly, you'll see an empty screen.
        </div>
        <a href="/" class="secondary-button">Go to Homepage</a>
    </div>

    <script>
        // Extract share token from URL
        console.log('üîç Share page loaded');
        console.log('Full URL:', window.location.href);
        console.log('Pathname:', window.location.pathname);
        console.log('Search:', window.location.search);
        
        // Parse token from path: /share/TOKEN or query param ?token=TOKEN
        const urlParams = new URLSearchParams(window.location.search);
        const tokenFromQuery = urlParams.get('token');
        
        // Extract token from path: /share/TOKEN -> TOKEN
        const pathParts = window.location.pathname.split('/').filter(p => p.length > 0);
        const tokenFromPath = pathParts.length >= 2 ? pathParts[1] : null; // Index 0 is 'share', index 1 is TOKEN
        
        console.log('Path parts:', pathParts);
        console.log('Token from query param:', tokenFromQuery);
        console.log('Token from path:', tokenFromPath);
        
        const shareToken = tokenFromQuery || tokenFromPath;
        console.log('Final shareToken:', shareToken);
        
        // Detect redirect loop (if we've been here multiple times)
        const visitCount = parseInt(sessionStorage.getItem('shareVisitCount') || '0') + 1;
        sessionStorage.setItem('shareVisitCount', visitCount.toString());
        console.log('Visit count:', visitCount);
        
        const message = document.getElementById('message');
        const status = document.getElementById('status');
        const openButton = document.getElementById('openButton');
        const installButton = document.getElementById('installButton');
        const gridName = document.getElementById('gridName');
        const gridInfo = document.getElementById('gridInfo');
        const infoBox = document.getElementById('infoBox');
        
        // Fetch grid metadata from API
        async function loadGridMetadata() {
            try {
                const response = await fetch(`https://pitchgrid-api.proliferaite.workers.dev/shares/${shareToken}/metadata`);
                if (response.ok) {
                    const data = await response.json();
                    gridName.textContent = data.name || 'Shared Grid';
                    const clipText = data.clip_count === 1 ? '1 clip' : `${data.clip_count} clips`;
                    gridInfo.textContent = `${data.owner_name} shared ${clipText} with you`;
                    message.textContent = `Opening "${data.name}" in PitchGrid...`;
                }
            } catch (error) {
                console.error('Failed to load grid metadata:', error);
                // Continue with default text if metadata fails
            }
        }
        
        // Validate token (should be 10 characters, alphanumeric)
        const isValidToken = shareToken && 
                            shareToken !== 'share.html' && 
                            shareToken !== 'share' &&
                            shareToken.length === 10 &&
                            /^[a-z0-9]+$/.test(shareToken);
        
        if (isValidToken) {
            // Load metadata in background
            loadGridMetadata();
            
            // Construct both link types
            const universalLink = `https://pitchgridapp.com/share/${shareToken}`;
            const deepLink = `pitchgrid://share/${shareToken}`;
            
            console.log('‚úÖ Valid token');
            console.log('Universal link:', universalLink);
            console.log('Deep link:', deepLink);
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            // Set up install button based on platform
            if (isIOS) {
                installButton.textContent = "Get PitchGrid from App Store";
                installButton.href = "https://apps.apple.com/app/pitchgrid/id6748971191";
            } else if (isAndroid) {
                installButton.textContent = "Get PitchGrid from Google Play";
                installButton.href = "https://play.google.com/store/apps/details?id=com.proliferaite.pitchgrid";
            } else {
                installButton.textContent = "Get PitchGrid";
                installButton.href = "/";
            }
            
            // Set up open button to always try custom scheme
            openButton.href = deepLink;
            openButton.onclick = function(e) {
                e.preventDefault();
                console.log('üîó Trying to open in app:', deepLink);
                window.location.href = deepLink;
            };
            
            // If we've been here before (redirect loop), skip auto-redirect
            if (visitCount > 2) {
                console.warn('‚ö†Ô∏è Redirect loop detected, showing manual options');
                status.style.display = 'none';
                openButton.style.display = 'inline-block';
                installButton.style.display = 'inline-block';
                message.textContent = "Choose an option below";
                infoBox.classList.add('show');
            } else {
                // First visit: Try to open automatically
                console.log('üöÄ First visit, attempting auto-open');
                
                // Try custom scheme first (works immediately for installed apps)
                console.log('Trying custom scheme:', deepLink);
                window.location.href = deepLink;
                
                // After 2 seconds, show BOTH buttons
                setTimeout(() => {
                    status.style.display = 'none';
                    openButton.style.display = 'inline-block';
                    installButton.style.display = 'inline-block';
                    message.textContent = "Choose an option below";
                    infoBox.classList.add('show');
                }, 2000);
            }
        } else {
            // Invalid or missing token
            console.error('‚ùå Invalid token:', shareToken);
            console.error('Token validation failed - must be 10 lowercase alphanumeric characters');
            status.innerHTML = '';
            message.textContent = "Invalid share link. Please check the URL and try again.";
            message.style.color = '#ff6b6b';
        }
    </script>
</body>
</html>

